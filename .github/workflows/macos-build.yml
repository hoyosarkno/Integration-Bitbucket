name: MacOS Build

on:
  workflow_dispatch:  # Permite ejecución manual
  repository_dispatch:  # Recibe el webhook de Bitbucket
    types: [bitbucket_trigger]
  push:
    branches:
      - main
      - develop  # Solo se ejecuta en estas ramas

jobs:
  build:
    runs-on: macos-latest

    steps:
      # Descargar código fuente
      - name: Descargar código fuente
        run: |
          echo "Voy a clonar el repo"
          git clone -b Test --single-branch https://${{ secrets.BITBUCKET_USER }}:${{ secrets.BITBUCKET_ACCESS_TOKEN }}@bitbucket.org/svillaquiral/appprovandroid.git
          cd appprovandroid
          cd ios

      # Cache de Flutter SDK
      - name: Cache Flutter SDK
        uses: actions/cache@v3
        with:
          path: ~/.flutter
          key: flutter-${{ runner.os }}-${{ hashFiles('**/flutter/version') }}
          restore-keys: |
            flutter-${{ runner.os }}-

      # Descargar e instalar Flutter 3.22.3 si no está en caché
      - name: Instalar Flutter 3.22.3
        run: |
          echo "Instalando Flutter 3.22.3"
          if [ ! -d "/opt/flutter" ]; then
            echo "Descargando Flutter SDK..." 
            curl -LO https://storage.googleapis.com/flutter_infra_release/releases/stable/macos/flutter_macos_3.22.3-stable.tar.xz
            tar xf flutter_macos_3.22.3-stable.tar.xz
            mv flutter /opt/flutter
          fi

      # Agregar Flutter al PATH
      - name: Exportar Flutter al PATH
        run: |
          echo "Agregando Flutter al PATH"
          export PATH="$PATH:/opt/flutter/bin"
          flutter doctor

      # Verificar la instalación de Flutter
      - name: Verificar Flutter
        run: |
          flutter --version
          flutter doctor || { echo 'Flutter no está disponible'; exit 1; }

      # Instalar dependencias de Flutter
      - name: Instalar dependencias de Flutter
        run: |
          echo "Instalando dependencias de Flutter"
          flutter pub get

      # Instalar Fastlane
      - name: Instalar Fastlane
        run: |
          echo "Instalando Fastlane"
          gem install fastlane

      # Ejecutar Fastlane ios beta
      - name: Ejecutar Fastlane ios beta
        run: |
          echo "Ejecutando fastlane ios beta"
          cd ios
          fastlane ios beta

      # Guardar caché de dependencias
      - name: Guardar caché de dependencias
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            ios/Pods
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml', '**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-
